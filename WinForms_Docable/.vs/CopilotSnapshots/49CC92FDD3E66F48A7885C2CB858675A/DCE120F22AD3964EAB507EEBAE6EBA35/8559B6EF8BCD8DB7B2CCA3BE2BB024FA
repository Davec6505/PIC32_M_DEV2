using ICSharpCode.AvalonEdit.Highlighting;
using ICSharpCode.AvalonEdit.Highlighting.Xshd;
using System;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Threading;
using System.Windows.Forms;
using System.Windows.Forms.Integration;
using WeifenLuo.WinFormsUI.Docking;
using System.Xml;
using System.Drawing; // ADDED
using WinForms_Docable.Properties;

namespace WinForms_Docable
{
    public partial class Form1 : Form
    {
        private DockPanel dockPanel = null!;
        private DeserializeDockContent _deserializeDockContent;

        // Project explorer panel reference and state
        private ProjectTreePanel? _projectPanel;
        private string? _currentProjectPath;
        private string? _currentTreeSavePath;

        // PowerShell panel reference (to set working directory)
        private PowerShellPanel? _psPanel;

        // Open editors cache by full path
        private readonly Dictionary<string, CodeEditorPanel> _openEditors = new(StringComparer.OrdinalIgnoreCase);

        // THEME STATE
        private bool _darkMode = false; // default light

        public Form1()
        {
            InitializeComponent();

            // Make this the MDI container for DockPanelSuite
            this.IsMdiContainer = true;

            _darkMode = Settings.Default.DarkMode;
            _deserializeDockContent = new DeserializeDockContent(GetContentFromPersistString);

            dockPanel = new DockPanel { Dock = DockStyle.Fill, DocumentStyle = DocumentStyle.DockingSdi };
            Controls.Add(dockPanel);

            dockPanel.Theme = _darkMode ? new VS2015DarkTheme() : new VS2015BlueTheme();
            InitializeMenu();
            ApplyNonDockPanelTheme(_darkMode);

            var layoutPath = Path.Combine(AppContext.BaseDirectory, "layout.xml");
            if (File.Exists(layoutPath))
            {
                try
                {
                    dockPanel.LoadFromXml(layoutPath, _deserializeDockContent);
                    if (_projectPanel != null)
                    {
                        _projectPanel.FileNodeActivated -= ProjectPanel_FileNodeActivated;
                        _projectPanel.FileNodeActivated += ProjectPanel_FileNodeActivated;
                    }
                    if (_psPanel != null && !string.IsNullOrEmpty(_currentProjectPath))
                        _psPanel.SetWorkingDirectory(_currentProjectPath);

                    ApplyThemeToAllDockContents(_darkMode);
                }
                catch
                {
                    InitializeDocking();
                    ApplyThemeToAllDockContents(_darkMode);
                }
            }
            else
            {
                InitializeDocking();
                ApplyThemeToAllDockContents(_darkMode);
            }
        }

        private void Form1_Load(object sender, EventArgs e)
        {

        }

        private void LoadDefaultLayout()
        {
            // Recreate tool panes; no document placeholder
            InitializeDocking();
        }

        // Add helpers
        private ProjectTreePanel CreateProjectPanel()
        {
            var panel = new ProjectTreePanel
            {
                DockAreas = DockAreas.DockLeft,
                AllowEndUserDocking = false,
                CloseButton = false
            };
            panel.FileNodeActivated -= ProjectPanel_FileNodeActivated;
            panel.FileNodeActivated += ProjectPanel_FileNodeActivated;
            panel.ApplyTheme(_darkMode);
            return panel;
        }

        private PowerShellPanel CreatePowerShellPanel()
        {
            var panel = new PowerShellPanel();
            if (!string.IsNullOrEmpty(_currentProjectPath))
                panel.SetWorkingDirectory(_currentProjectPath);
            panel.ApplyTheme(_darkMode);
            return panel;
        }

        // Update deserializer to use creators (so wiring happens on restore too)
        private IDockContent GetContentFromPersistString(string persistString)
        {
            return persistString switch
            {
                "WinForms_Docable.ProjectTreePanel" or "Project Explorer" => (_projectPanel ??= CreateProjectPanel()),
                "WinForms_Docable.PowerShellPanel" or "PowerShell" => (_psPanel ??= CreatePowerShellPanel()),
                "Right Panel" => new ToolWindow("Right Panel"),
                "Main Document" => new ToolWindow("Main Document"),
                _ => new ToolWindow(persistString)
            };
        }

        private void InitializeDocking()
        {
            // DO NOT recreate dockPanel; it already exists and has Theme set

            _projectPanel = CreateProjectPanel();
            _projectPanel.Show(dockPanel, DockState.DockLeft);

            new ToolWindow("Right Panel").Show(dockPanel, DockState.DockRight);

            _psPanel = CreatePowerShellPanel();
            _psPanel.Show(dockPanel, DockState.DockBottomAutoHide);

            // No "Main Document" placeholder needed in MDI
        }

        private void ProjectPanel_FileNodeActivated(object? sender, string filePath)
        {
            OpenFileInEditor(filePath);
        }

        private void OpenFileInEditor(string filePath)
        {
            if (!File.Exists(filePath)) return;

            if (_openEditors.TryGetValue(filePath, out var existing))
            {
                existing.Show(dockPanel, DockState.Document);
                existing.Activate();
                return;
            }

            var editor = new CodeEditorPanel(filePath);
            _openEditors[filePath] = editor;
            editor.FormClosed += (s, e) => _openEditors.Remove(filePath);
            editor.Show(dockPanel, DockState.Document);
            editor.Activate();

            // Ensure new editors follow current theme
            editor.ApplyTheme(_darkMode);
        }

        // File menu (Open, Save, Save As, Close, Exit)
        private MenuStrip? _menuStrip;
        private ToolStripMenuItem? _fileMenu;
        private ToolStripMenuItem? _openMenuItem;
        private ToolStripMenuItem? _saveMenuItem;
        private ToolStripMenuItem? _saveAsMenuItem;
        private ToolStripMenuItem? _closeMenuItem;
        private ToolStripMenuItem? _exitMenuItem;

        // View menu (Dark Mode toggle)
        private ToolStripMenuItem? _viewMenu;              // ADDED
        private ToolStripMenuItem? _darkModeMenuItem;      // ADDED

        public object Properties { get; private set; }

        private void InitializeMenu()
        {
            _menuStrip = new MenuStrip();

            // File
            _fileMenu = new ToolStripMenuItem("File");
            _openMenuItem = new ToolStripMenuItem("Open", null, OnOpenClicked);
            _saveMenuItem = new ToolStripMenuItem("Save", null, OnSaveClicked);
            _saveAsMenuItem = new ToolStripMenuItem("Save As", null, OnSaveAsClicked);
            _closeMenuItem = new ToolStripMenuItem("Close", null, OnCloseProjectClicked);
            _exitMenuItem = new ToolStripMenuItem("Exit", null, (s, e) => this.Close());

            _fileMenu.DropDownItems.AddRange(new ToolStripItem[]
            {
                _openMenuItem,
                new ToolStripSeparator(),
                _saveMenuItem,
                _saveAsMenuItem,
                new ToolStripSeparator(),
                _closeMenuItem,
                new ToolStripSeparator(),
                _exitMenuItem
            });

            // View
            _viewMenu = new ToolStripMenuItem("View");
            _darkModeMenuItem = new ToolStripMenuItem("Dark Mode")
            {
                CheckOnClick = true,
                Checked = _darkMode
            };
            _darkModeMenuItem.Click += (s, e) =>
            {
                Settings.Default.DarkMode = _darkModeMenuItem.Checked;
                Settings.Default.Save();
                Application.Restart();
                Environment.Exit(0);
            };
            _viewMenu.DropDownItems.Add(_darkModeMenuItem);

            _menuStrip.Items.AddRange(new ToolStripItem[] { _fileMenu!, _viewMenu });
            this.MainMenuStrip = _menuStrip;
            this.Controls.Add(_menuStrip);

            UpdateFileMenuState();
        }

        private void UpdateFileMenuState()
        {
            bool hasProject = !string.IsNullOrEmpty(_currentProjectPath);
            if (_saveMenuItem != null) _saveMenuItem.Enabled = hasProject;
            if (_saveAsMenuItem != null) _saveAsMenuItem.Enabled = hasProject;
            if (_closeMenuItem != null) _closeMenuItem.Enabled = hasProject;
        }

        private void OnOpenClicked(object? sender, EventArgs e)
        {
            using var dlg = new FolderBrowserDialog
            {
                Description = "Select a project folder to load into the Project Explorer"
            };
            if (dlg.ShowDialog(this) == DialogResult.OK)
            {
                _currentProjectPath = dlg.SelectedPath;
                _currentTreeSavePath = null; // reset save path
                EnsureProjectPanel();
                _projectPanel!.LoadFromDirectory(_currentProjectPath);

                // Point PowerShell to the selected project's folder
                _psPanel?.SetWorkingDirectory(_currentProjectPath);

                UpdateFileMenuState();
            }
        }

        private void OnSaveClicked(object? sender, EventArgs e)
        {
            if (string.IsNullOrEmpty(_currentProjectPath)) return;
            if (string.IsNullOrEmpty(_currentTreeSavePath))
            {
                OnSaveAsClicked(sender, e);
                return;
            }
            EnsureProjectPanel();
            _projectPanel!.SaveTreeToFile(_currentTreeSavePath!);
        }

        private void OnSaveAsClicked(object? sender, EventArgs e)
        {
            if (string.IsNullOrEmpty(_currentProjectPath)) return;
            using var dlg = new SaveFileDialog
            {
                Title = "Save Project Tree As",
                Filter = "Tree Export (*.tree.txt)|*.tree.txt|All Files (*.*)|*.*",
                FileName = "Project.tree.txt"
            };
            if (dlg.ShowDialog(this) == DialogResult.OK)
            {
                _currentTreeSavePath = dlg.FileName;
                EnsureProjectPanel();
                _projectPanel!.SaveTreeToFile(_currentTreeSavePath);
            }
        }

        private void OnCloseProjectClicked(object? sender, EventArgs e)
        {
            _currentProjectPath = null;
            _currentTreeSavePath = null;
            EnsureProjectPanel();
            _projectPanel!.ClearProject();
            UpdateFileMenuState();
        }

        private void EnsureProjectPanel()
        {
            if (_projectPanel == null || _projectPanel.IsDisposed)
            {
                _projectPanel = new ProjectTreePanel
                {
                    DockAreas = DockAreas.DockLeft,
                    AllowEndUserDocking = false,
                    CloseButton = false
                };
                _projectPanel.FileNodeActivated += ProjectPanel_FileNodeActivated;
                _projectPanel.Show(dockPanel, DockState.DockLeft);
            }
        }

        // THEME: Apply dark/light to the whole WinForms app and DockPanel
        private void ApplyAppTheme(bool darkMode)
        {
            // Do NOT set dockPanel.Theme here
            ApplyNonDockPanelTheme(darkMode);

            foreach (var ed in _openEditors.Values.ToArray())
            {
                if (!ed.IsDisposed) ed.ApplyTheme(darkMode);
            }

            ApplyWinFormsThemeRecursive(this, darkMode);
            if (_darkModeMenuItem != null) _darkModeMenuItem.Checked = darkMode;
        }

        private static void ApplyWinFormsThemeRecursive(Control root, bool darkMode)
        {
            // Skip DockPanel as it is themed by DockPanelSuite
            if (root is DockPanel) return;

            if (root is ToolStrip ts)
            {
                ts.BackColor = darkMode ? Color.FromArgb(45, 45, 48) : SystemColors.Control;
                ts.ForeColor = darkMode ? Color.Gainsboro : SystemColors.ControlText;
            }
            else
            {
                root.BackColor = darkMode ? Color.FromArgb(37, 37, 38) : SystemColors.Control;
                root.ForeColor = darkMode ? Color.Gainsboro : SystemColors.ControlText;
            }

            foreach (Control child in root.Controls)
                ApplyWinFormsThemeRecursive(child, darkMode);
        }
        private void ToggleTheme(bool darkMode)
        {
            this.SuspendLayout();
            dockPanel.SuspendLayout();

            var layoutPath = Path.Combine(AppContext.BaseDirectory, "layout_tmp.xml");
            dockPanel.SaveAsXml(layoutPath);

            foreach (var content in dockPanel.DocumentsToArray())
                (content as IDockContent)?.DockHandler.Close();
            foreach (var content in dockPanel.Contents.ToArray())
                (content as IDockContent)?.DockHandler.Close();

            dockPanel.Theme = darkMode ? new VS2015DarkTheme() : new VS2015BlueTheme();

            // Do NOT change DocumentStyle here
            // dockPanel.DocumentStyle = DocumentStyle.DockingMdi; // remove this line

            if (File.Exists(layoutPath))
            {
                try { dockPanel.LoadFromXml(layoutPath, _deserializeDockContent); }
                catch { LoadDefaultLayout(); }
            }
            else
            {
                LoadDefaultLayout();
            }

            dockPanel.DockLeftPortion = 0.25;
            dockPanel.DockRightPortion = 0.25;
            dockPanel.DockBottomPortion = 0.25;

            ApplyNonDockPanelTheme(darkMode);

            dockPanel.ResumeLayout(true);
            this.ResumeLayout(true);
            dockPanel.PerformLayout();
            this.PerformLayout();
        }

        private void ApplyNonDockPanelTheme(bool darkMode)
        {
            dockPanel.BackColor = darkMode ? Color.FromArgb(30, 30, 30) : SystemColors.Control;
            this.BackColor = darkMode ? Color.FromArgb(37, 37, 38) : SystemColors.Control;
            this.ForeColor = darkMode ? Color.Gainsboro : SystemColors.ControlText;
            // ...menu and recursive colors...
        }
        // ToolStrip color tables
        private sealed class DarkColorTable : ProfessionalColorTable
        {
            public override Color ToolStripDropDownBackground => Color.FromArgb(45, 45, 48);
            public override Color MenuItemSelected => Color.FromArgb(62, 62, 64);
            public override Color MenuItemBorder => Color.FromArgb(104, 104, 104);
            public override Color ImageMarginGradientBegin => Color.FromArgb(45, 45, 48);
            public override Color ImageMarginGradientMiddle => Color.FromArgb(45, 45, 48);
            public override Color ImageMarginGradientEnd => Color.FromArgb(45, 45, 48);
            public override Color MenuStripGradientBegin => Color.FromArgb(45, 45, 48);
            public override Color MenuStripGradientEnd => Color.FromArgb(45, 45, 48);
            public override Color SeparatorDark => Color.FromArgb(62, 62, 64);
            public override Color SeparatorLight => Color.FromArgb(62, 62, 64);
        }

        private sealed class LightColorTable : ProfessionalColorTable
        {
            public override Color ToolStripDropDownBackground => SystemColors.ControlLightLight;
            public override Color MenuItemSelected => Color.FromArgb(221, 236, 254);
            public override Color MenuItemBorder => Color.FromArgb(147, 160, 207);
            public override Color ImageMarginGradientBegin => SystemColors.Control;
            public override Color ImageMarginGradientMiddle => SystemColors.Control;
            public override Color ImageMarginGradientEnd => SystemColors.Control;
            public override Color MenuStripGradientBegin => SystemColors.Control;
            public override Color MenuStripGradientEnd => SystemColors.Control;
        }
    }

    internal static class Diagnostics
    {
        public static void Run()
        {
            // 1) Verify method existence
            var method = typeof(Mutex).GetMethod(
                "SetAccessControl",
                new[] { typeof(System.Security.AccessControl.MutexSecurity) });
            Debug.WriteLine("Has Mutex.SetAccessControl: " + (method != null));

            // 2) Log loaded assemblies early
            AppDomain.CurrentDomain.AssemblyLoad += (s, e) =>
            {
                try
                {
                    var loc = e.LoadedAssembly.Location;
                    Debug.WriteLine($"Loaded: {e.LoadedAssembly.FullName} @ {loc}");
                }
                catch { Debug.WriteLine($"Loaded: {e.LoadedAssembly.FullName} (dynamic/no location)"); }
            };
        }


        private static IHighlightingDefinition LoadFromFile(string relativePath)
        {
            var path = Path.Combine(AppContext.BaseDirectory, relativePath);
            using var s = File.OpenRead(path);
            using var reader = new XmlTextReader(s);
            var xshd = HighlightingLoader.LoadXshd(reader);
            return HighlightingLoader.Load(xshd, HighlightingManager.Instance);
        }
        // usage: LoadFromFile(@"Highlighting\Makefile.xshd")

    }


}
